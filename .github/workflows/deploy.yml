name: Deploy

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout
        uses: actions/checkout@v4

      - name: ğŸ”‘ Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERUSERNAME }}
          password: ${{ secrets.DOCKERPASSWORD }}

      - name: ğŸ·ï¸ Set tags
        id: vars
        run: |
          echo "sha_tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: ğŸ— Build
        run: |
          docker build -t daonyoon/match_on_nest:latest \
                       -t daonyoon/match_on_nest:${{ steps.vars.outputs.sha_tag }} .

      - name: ğŸ“¤ Push
        run: |
          docker push daonyoon/match_on_nest:latest
          docker push daonyoon/match_on_nest:${{ steps.vars.outputs.sha_tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVERHOST }}
          username: ${{ secrets.SERVERID }}
          key: ${{ secrets.SERVERSSHKEY }}
          port: 22
          script_stop: true
          script: |
            set -eo pipefail

            echo "ğŸ”‘ Docker Hub login on server"
            echo '${{ secrets.DOCKERPASSWORD }}' | docker login -u '${{ secrets.DOCKERUSERNAME }}' --password-stdin

            echo "ğŸ³ Pull image"
            docker pull daonyoon/match_on_nest:latest

            echo "ğŸ§¹ Stop & remove old container"
            docker rm -f match_on_nest || true

            echo "ğŸš€ Run new container"
            docker run -d --name match_on_nest \
              -p 4003:4003 \
              -e NODE_ENV=production \
              -e PORT=4003 \
              -e AWS_CLIENT_KEY='${{ secrets.AWS_CLIENT_KEY }}' \
              -e AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}' \
              -e AWS_S3_REGION='${{ secrets.AWS_S3_REGION }}' \
              -e AWS_S3_BUCKET='${{ secrets.AWS_S3_BUCKET }}' \
              daonyoon/match_on_nest:latest

            echo "ğŸ§½ Prune dangling images"
            docker image prune -f
